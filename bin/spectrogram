#!/usr/bin/env sh

# NOTE: This'll choke on weird filenames. Try `rename --sanitize *.wav` first.

# Create a gradient color map.
convert \( -size 1x1 xc:black xc:red xc:yellow xc:white +append \) -filter cubic -resize 256x1! -scale 256x20! .colors.png

for file in "$@"
do
	echo "=> Generating spectrogram for $file"

	# Generate a double-height spectrogram (220KHz).
	sox "$file" .temp.wav spectrogram -r -x 720 -y 1025 -z 80 -o .temp.png
	rm .temp.wav

	# Crop to normal height (110KHz).
	convert .temp.png -crop 100%x50%+0+512 .temp.half.png
	rm .temp.png

	# Convert to grayscale.
	convert .temp.half.png -colorspace gray .temp.gray.png
	rm .temp.half.png

	# Recolor the image.
	convert .temp.gray.png .colors.png -clut "$file.png"
	rm .temp.gray.png
done

rm .colors.png
